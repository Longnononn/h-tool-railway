<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Android Emulator (via v86)</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #000;
      color: white;
    }
    #screen_container {
      display: inline-block;
      margin-top: 20px;
    }
    select, button {
      margin: 10px;
      padding: 8px 16px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Android Emulator in Browser</h1>
  <div>
    <label for="mode">Chế độ:</label>
    <select id="mode">
      <option value="normal">Normal</option>
      <option value="debug">Debug</option>
    </select>
    <button id="runBtn">Bắt đầu</button>
    <button id="stopBtn">Tắt</button>
  </div>

  <div id="screen_container"></div>

  <script>
    let emulator = null;

    const FILES = {
      normal: {
        libv86_js: "https://copy.sh/v86/build/libv86.js",
        wasm: "https://copy.sh/v86/build/v86.wasm",
      },
      debug: {
        libv86_js: "https://copy.sh/v86/build/libv86-debug.js",
        wasm: "https://copy.sh/v86/build/v86-debug.wasm",
      },
      bios_seabios: "https://copy.sh/v86/bios/seabios.bin",
      bios_vgabios: "https://copy.sh/v86/bios/vgabios.bin",
      iso: "https://drive.google.com/uc?export=download&id=1Q0kF7Wx12J2dOsbqptD7XC8IpwWirbcb"
    };

    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const old = document.getElementById("libv86script");
        if (old) old.remove();
        const s = document.createElement("script");
        s.src = url;
        s.id = "libv86script";
        s.onload = () => {
          const waitForV86 = setInterval(() => {
            if (typeof V86Starter !== 'undefined') {
              clearInterval(waitForV86);
              resolve();
            }
          }, 100);
        };
        s.onerror = () => reject(new Error(`Failed to load script: ${url}`));
        document.body.appendChild(s);
      });
    }

    async function startEmulator() {
      if (emulator) {
        emulator.stop();
        emulator = null;
      }

      const mode = document.getElementById("mode").value;
      try {
        await loadScript(FILES[mode].libv86_js);

        emulator = new V86Starter({
          wasm_path: FILES[mode].wasm,
          memory_size: 1024 * 1024 * 1024,
          vga_memory_size: 8 * 1024 * 1024,
          screen_container: document.getElementById("screen_container"),
          bios: { url: FILES.bios_seabios },
          vga_bios: { url: FILES.bios_vgabios },
          cdrom: { url: FILES.iso },
          autostart: true,
        });

        emulator.add_listener("emulator-message", e => console.log("[v86]", e.detail));
        emulator.add_listener("emulator-error", e => console.error("[v86 ERROR]", e.detail));
      } catch (e) {
        alert("Lỗi khi khởi động emulator: " + e.message);
      }
    }

    function stopEmulator() {
      if (emulator) {
        emulator.stop();
        emulator = null;
        document.getElementById("screen_container").innerHTML = "";
      }
    }

    document.getElementById("runBtn").addEventListener("click", startEmulator);
    document.getElementById("stopBtn").addEventListener("click", stopEmulator);
  </script>
</body>
</html>
